# Configuración de PRUEBA con imágenes públicas
# Usa este archivo para validar que el despliegue funciona
# Comando: helm install comments-system ./helm/comments-system -f ./helm/comments-system/values-test.yaml

global:
  namespace: default
  domain: apps.sandbox.openshiftapps.com
  registry: docker.io

microservices:
  - name: frontend
    enabled: true
    image:
      repository: nginx
      tag: alpine
      pullPolicy: IfNotPresent

    replicas: 1

    port: 80
    targetPort: 80

    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"

    livenessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 10
      periodSeconds: 10

    readinessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 5

    env: []

    route:
      enabled: true
      host: ""
      tls:
        enabled: true
        termination: edge
        insecureEdgeTerminationPolicy: Redirect

    autoscaling:
      enabled: false

    labels:
      app: comments-system
      component: frontend
      tier: presentation

  - name: backend-api
    enabled: true
    image:
      repository: hashicorp/http-echo
      tag: latest
      pullPolicy: IfNotPresent

    replicas: 1

    port: 3000
    targetPort: 5678

    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"

    livenessProbe:
      httpGet:
        path: /
        port: 5678
      initialDelaySeconds: 10
      periodSeconds: 10

    readinessProbe:
      httpGet:
        path: /
        port: 5678
      initialDelaySeconds: 5
      periodSeconds: 5

    env:
      - name: PORT
        value: "5678"
      - name: TEXT
        value: "Backend API - OK"

    route:
      enabled: false

    autoscaling:
      enabled: false

    labels:
      app: comments-system
      component: backend-api
      tier: application

  - name: backend-data
    enabled: true
    image:
      repository: hashicorp/http-echo
      tag: latest
      pullPolicy: IfNotPresent

    replicas: 1

    port: 3001
    targetPort: 5678

    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"

    livenessProbe:
      httpGet:
        path: /
        port: 5678
      initialDelaySeconds: 10
      periodSeconds: 10

    readinessProbe:
      httpGet:
        path: /
        port: 5678
      initialDelaySeconds: 5
      periodSeconds: 5

    env:
      - name: PORT
        value: "5678"
      - name: TEXT
        value: "Backend Data - OK"

    route:
      enabled: false

    autoscaling:
      enabled: false

    labels:
      app: comments-system
      component: backend-data
      tier: data-access

  - name: postgres
    enabled: true
    image:
      repository: postgres
      tag: "15-alpine"
      pullPolicy: IfNotPresent

    replicas: 1

    port: 5432
    targetPort: 5432

    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "250m"

    livenessProbe:
      exec:
        command:
          - pg_isready
          - -U
          - postgres
      initialDelaySeconds: 30
      periodSeconds: 10

    readinessProbe:
      exec:
        command:
          - pg_isready
          - -U
          - postgres
      initialDelaySeconds: 10
      periodSeconds: 5

    env:
      - name: POSTGRES_DB
        valueFrom:
          secretKeyRef:
            name: postgres-secret
            key: database
      - name: POSTGRES_USER
        valueFrom:
          secretKeyRef:
            name: postgres-secret
            key: username
      - name: POSTGRES_PASSWORD
        valueFrom:
          secretKeyRef:
            name: postgres-secret
            key: password
      - name: PGDATA
        value: /var/lib/postgresql/data/pgdata

    persistence:
      enabled: true
      storageClass: ""
      accessMode: ReadWriteOnce
      size: 2Gi
      mountPath: /var/lib/postgresql/data

    route:
      enabled: false

    autoscaling:
      enabled: false

    labels:
      app: comments-system
      component: postgres
      tier: database

secrets:
  postgres:
    name: postgres-secret
    data:
      database: Y29tbWVudHNfZGI=
      username: cG9zdGdyZXM=
      password: cG9zdGdyZXNAMTIzNDU=

configmaps: []

networkPolicies:
  enabled: true
  denyAll:
    enabled: true
  rules:
    - name: allow-frontend-to-backend-api
      podSelector:
        component: backend-api
      ingress:
        - from:
            - podSelector:
                component: frontend
          ports:
            - protocol: TCP
              port: 5678

    - name: allow-backend-api-to-backend-data
      podSelector:
        component: backend-data
      ingress:
        - from:
            - podSelector:
                component: backend-api
          ports:
            - protocol: TCP
              port: 5678

    - name: allow-backend-data-to-postgres
      podSelector:
        component: postgres
      ingress:
        - from:
            - podSelector:
                component: backend-data
          ports:
            - protocol: TCP
              port: 5432

    - name: allow-ingress-to-frontend
      podSelector:
        component: frontend
      ingress:
        - from:
            - namespaceSelector:
                matchLabels:
                  network.openshift.io/policy-group: ingress
          ports:
            - protocol: TCP
              port: 80
